<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<meta http-equiv="X-UA-Compatible" content="IE=9"/>
<meta name="generator" content="Doxygen 1.8.13"/>
<meta name="viewport" content="width=device-width, initial-scale=1"/>
<title>5MP Motion Camera JPEG Image and Movie Catcher: How to Build a CGI That Does Image Processing for a 5 Mega-pixel Motion Activated WiFi Camera</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="dynsections.js"></script>
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtreedata.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/searchdata.js"></script>
<script type="text/javascript" src="search/search.js"></script>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
</head>
<body>
<div id="top"><!-- do not remove this div, it is closed by doxygen! -->
<div id="titlearea">
<table cellspacing="0" cellpadding="0">
 <tbody>
 <tr style="height: 56px;">
  <td id="projectalign" style="padding-left: 0.5em;">
   <div id="projectname">5MP Motion Camera JPEG Image and Movie Catcher
   &#160;<span id="projectnumber">1.1.1.1</span>
   </div>
   <div id="projectbrief">A CGI interface to capture and display pictures and movies using OpenCV.</div>
  </td>
 </tr>
 </tbody>
</table>
</div>
<!-- end header part -->
<!-- Generated by Doxygen 1.8.13 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="menudata.js"></script>
<script type="text/javascript" src="menu.js"></script>
<script type="text/javascript">
$(function() {
  initMenu('',true,false,'search.php','Search');
  $(document).ready(function() { init_search(); });
});
</script>
<div id="main-nav"></div>
</div><!-- top -->
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
      <div id="nav-sync" class="sync"></div>
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
$(document).ready(function(){initNavTree('index.html','');});
</script>
<div id="doc-content">
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
</div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

<div class="header">
  <div class="headertitle">
<div class="title">How to Build a CGI That Does Image Processing for a 5 Mega-pixel Motion Activated WiFi Camera </div>  </div>
</div><!--header-->
<div class="contents">
<div class="textblock"><p>This project demonstrates how to receive images from <a href="https://github.com/patrickmoffitt/5mp_motion_camera/">this camera</a> and process them into still images and movies using OpenCV and FFMPEG on Raspbian Buster (recently rebranded as Raspberry Pi OS). The camera sends the following JSON message via HTTP POST:</p>
<div class="fragment"><div class="line">{</div><div class="line">  &quot;body&quot;: [</div><div class="line">    {</div><div class="line">      &quot;name&quot;: &quot;battery_percent&quot;,</div><div class="line">      &quot;value&quot;: &quot;96&quot;</div><div class="line">    },</div><div class="line">    {</div><div class="line">      &quot;name&quot;: &quot;5MP_MC&quot;,</div><div class="line">      &quot;frames&quot;: 0,</div><div class="line">      &quot;content_type&quot;: &quot;image/jpeg&quot;,</div><div class="line">      &quot;value&quot;: &quot;&quot;</div><div class="line">    }</div><div class="line">  ]</div><div class="line">}</div></div><!-- fragment --><p> The battery data lands at the top of the image browsing page.</p>
<div class="image">
<img src="image_browsing.jpg" alt="image_browsing.jpg"/>
<div class="caption">
image browsing page</div></div>
<p>For more information about this page see the <a href="https://github.com/patrickmoffitt/camera_settings/">Camera Settings Project</a>. The rest of the data are used to process the <code>value</code> payload. (It has been elided for brevity. Imagine a very long base64 encoded string in its place.) The <code>name</code> field tells us which camera sent the data. If you have multiple cameras simply give them distinct names and all will be well. The <code>frames</code> counter lets us know if we should expect a single JPEG or multiples. Frames are numbered from zero so <code>0</code> frames yields one picture. If we get multiples we split them apart and order them by frame number. If we get the reserved value of <code>255</code> that tells us we've received an AVI/MJPEG movie. If it passes <a href="https://en.wikipedia.org/wiki/File_format#Magic_number">magic number</a> and FFMPEG validation we convert it to MP4 and save it as a movie. If it does not, we attempt to save as many frames as we can and fallback to saving frame numbered images. See <code><a class="el" href="classmjpeg__utils.html#aa3dca1a9b647fcecc6c9293229c51a4d">mjpeg_utils::save_avi_frames</a></code> for how FFMPEG is used within OpenCV to accomplish all this image processing.</p>
<h2>Building </h2>
<p>If you haven't already: </p><div class="fragment"><div class="line">sudo apt-get install build-essential libcurl-dev libmagic-dev</div></div><!-- fragment --><p> It's widely known that the hardest part of using OpenCV is getting it and its dependencies installed. Once you get past that it's a pleasure to use. I built this project on a Raspberry Pi model 4B running the latest (June 2020) Raspbian (now Raspberry Pi OS). I did that because I wanted the project to be accessible to those on a limited budget. The Pi is famously affordable and it has more than enough capability for the tasks at hand. That said, if you have access to a laptop running Ubuntu you might find that a better option. To begin the building, install Clang and LLVM. I copied these directions from <a href="https://apt.llvm.org/">https://apt.llvm.org/</a> so be sure to check there first to see if the directions have changed. BTW: You may be tempted to build with GCC; if you get it to work you're a better build master than me. After that, install OpenCV and it's dependencies. Lastly run <code>cmake</code> in the usual way in the project root folder.</p>
<h2>Installing the CGI </h2>
<p>On Raspbian, as root, do the following;</p><ol type="1">
<li>Copy the CGI binary you built (jpeg_catcher) with cmake into <code>/usr/lib/cgi-bin/</code> If you renamed the project in CMakeLists.txt the binary will have a new name as well. Be sure to reflect this name in <code>HTTP_HOST_URL</code> over in the <a href="https://github.com/patrickmoffitt/5mp_motion_camera/">camera project's</a> platformio.ini.</li>
<li>Enable the CGI module. <div class="fragment"><div class="line">sudo a2enmod cgi</div></div><!-- fragment --></li>
</ol>
<h2>Configuring the Web Root </h2>
<p>-1. As root, open <code>/etc/apache2/sites-available/000-default.conf</code> and paste the following in just above the closing <code>&lt;/VirtualHost&gt;</code> tag. </p><div class="fragment"><div class="line">&lt;Directory /var/www/html/motion_camera&gt;</div><div class="line">   Options +Indexes </div><div class="line">   AddType image/svg+xml svg svgz</div><div class="line">   AddEncoding gzip svgz</div><div class="line">   &lt;IfModule mod_autoindex.c&gt;</div><div class="line">       IndexOptions IgnoreCase FancyIndexing HTMLTable SuppressHTMLPreamble FoldersFirst VersionSort NameWidth=* DescriptionWidth=* XHTML IconHeight=16 IconWidth=16</div><div class="line">       IndexIgnore .. </div><div class="line">       IndexOrderDefault Descending Name</div><div class="line"></div><div class="line">       IndexStyleSheet ./fancy-index/style.css</div><div class="line">       HeaderName ./fancy-index/header.html</div><div class="line">       ReadmeName ./fancy-index/footer.html</div><div class="line"></div><div class="line">       # IGNORE THESE FILES</div><div class="line">       IndexIgnoreReset ON</div><div class="line">       IndexIgnore fancy-index </div><div class="line"></div><div class="line">       # DEFAULT ICON</div><div class="line">       DefaultIcon ./fancy-index/icons/file-text.svg</div><div class="line"></div><div class="line">       AddIcon ./fancy-index/icons/back.svg ..</div><div class="line">       AddIcon ./fancy-index/icons/file-directory.svg ^^DIRECTORY^^</div><div class="line">       # https://github.com/file-icons/source</div><div class="line">       AddIcon ./fancy-index/icons/file-media.svg .jpg .jpeg</div><div class="line">       AddIcon ./fancy-index/icons/Video.svg .avi .mp4</div><div class="line">       # https://upload.wikimedia.org/wikipedia/commons/d/da/Battery-303889.svg</div><div class="line">       AddIcon ./fancy-index/icons/battery.svg .pwr</div><div class="line">       AddDescription &quot;MPEG Layer 4 Format&quot; .mp4</div><div class="line">       AddDescription &quot;Joint Photographics Experts Group&quot; .jpg .jpeg .jpe .jfif</div><div class="line">       AddDescription &quot;Audio Video Interleave - Motion JPEG&quot; .avi</div><div class="line">       AddDescription &quot;Camera battery power available&quot; .pwr</div><div class="line"></div><div class="line">    &lt;/IfModule&gt;</div><div class="line">&lt;/Directory&gt;</div></div><!-- fragment --><p>-2. As root, make the directory <code>/var/www/html/motion_camera</code> and copy the contents of this project's [web_root](web_root) folder into it.</p>
<p>-3. Fix the ownership, group, and permissions. </p><div class="fragment"><div class="line">sudo mkdir /var/www/html/motion_camera</div><div class="line">cd /var/www/html/motion_camera</div><div class="line">sudo chown -R www-data:www-data</div><div class="line">sudo find . -type f -exec chmod 0644 {} \;</div><div class="line">sudo find . -type d -exec chmod 0755 {} \;</div></div><!-- fragment --><p>-4. When you're done <code>/var/www/html/motion_camera</code> will contain: </p><div class="fragment"><div class="line">ls -al /var/www/html/motion_camera/fancy-index/</div><div class="line">total 72</div><div class="line">drwxr-xr-x 3 www-data www-data  4096 Jun  9 09:37 .</div><div class="line">drwxr-xr-x 3 www-data www-data 40960 Jun 15 09:06 ..</div><div class="line">-rw-r--r-- 1 www-data www-data    66 Jun  5 15:53 footer.html</div><div class="line">-rw-r--r-- 1 www-data www-data   295 Jun  5 16:05 header.html</div><div class="line">drwxr-xr-x 2 www-data www-data  4096 Jun  8 15:35 icons</div><div class="line">-rw-r--r-- 1 www-data www-data  6322 Jun  8 15:48 script.js</div><div class="line">-rw-r--r-- 1 www-data www-data  3170 Jun  9 09:37 style.css</div></div><!-- fragment --><p>-5. You can now test the configuration by pointing your browser to <a href="http://your_server:4444/motion_camera">http://your_server:4444/motion_camera</a></p>
<h2>Debugging </h2>
<p>One of the handy things about the design of the CGI interface is that all error messages should be written to the standard error stream; <code>stderr</code>. The web server writes these into it's error log; <code>/var/log/apache2/error.log</code>. If this CGI encounters and error it will write a useful message about it to this file. To turn off this output edit <a href="debug_output.hpp">debug_output.hpp</a> and comment out <code>DEBUG_OUTPUT</code></p>
<h2>Do I Have to Use Apache? </h2>
<p>Certainly not. The CGI interface standard is supported by many different HTTP servers. You should have little difficulty adapting this project to work with your chosen web server.</p>
<h2>Resources </h2>
<p>There are also tools you may find useful to you in other projects. For example;</p><ul>
<li><a class="el" href="class_http__parser.html#a8fce31ead2c41d813a5cb2b511e73c0c">Http_parser::parse_query_string</a> stores the HTML query string in a <code>std::map&lt;std::string, std::vector&lt;std::string&gt;&gt;</code> From this you can create a project that handles HTML GET requests.</li>
<li><a class="el" href="class_http__parser.html#af6409633c0ac552a9c6597f5d1c7ebfb">Http_parser::parse_multipart_form</a> stores multipart/form-data encoded HTTP message bodies in two <code>std::map&lt;std::string, std::vector&lt;std::string&gt;&gt;</code> - one for variables and another for files. From this you can create a project where forms are used to control a robot/embedded system or your Raspberry Pi. To help you get started there is an <a href="test/multipart_form.html">everything-but-the-kitchen-sink HTML form</a>. Edit the <code>&lt;form&gt;</code> tag at the top and change the <code>action</code> attribute to reflect your server name.</li>
</ul>
<h2>Credits </h2>
<ul>
<li>Thank you to <a href="https://github.com/Vestride">Vestride</a> for the <a href="https://github.com/Vestride/fancy-index">Fancy Index project</a> from which I built the web page in this project.</li>
<li>Thank you to the <a href="https://github.com/opencv/opencv">OpenCV</a> project. I used one of the samples to learn how to do the image processing in this project.</li>
<li>Thank you to <a href="https://github.com/hjiang">hjiang</a> for the <a href="https://github.com/hjiang/jsonxx">jsonxx</a> project. I tested several C++ JSON libraries including <a href="https://github.com/open-source-parsers/jsoncpp">jsoncpp</a> before deciding to use jsonxx for its simplicity and speed.</li>
<li>Thank you to <a href="https://www.darwinsys.com/file/">Ian Darwin and Christos Zoulas</a> the inventor and maintainer (respectively) of all things magic number. I've been using the file(1) command all my life and was delighted to find the development library for it so easy to use.</li>
</ul>
<h2>Bugs, Issues, and Pull Requests </h2>
<p>If you find a bug please create an issue. If you'd like to contribute please send a pull request.</p>
<h2>References </h2>
<p>The following were helpful references in the development of this project.</p>
<ul>
<li><a href="http://httpd.apache.org/docs/current/howto/cgi.html">Apache Tutorial: Dynamic Content with CGI</a></li>
<li><a href="https://en.wikipedia.org/wiki/Common_Gateway_Interface">Common Gateway Interface</a></li>
<li><a href="https://opencv.org/links/">OpenCV Resources and Links</a> </li>
</ul>
</div></div><!-- contents -->
</div><!-- doc-content -->
<!-- start footer part -->
<div id="nav-path" class="navpath"><!-- id is needed for treeview function! -->
  <ul>
    <li class="footer">Generated by
    <a href="http://www.doxygen.org/index.html">
    <img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.8.13 </li>
  </ul>
</div>
</body>
</html>
